{% extends 'base.html' %}
{% block content %}
<h2>Heavy Chat</h2>
<div id="messages" class="border p-3 mb-3" style="height:400px; overflow:auto;"></div>
<form id="msgform">
  <div class="input-group">
    <input id="content" class="form-control" placeholder="Type a message...">
    <button class="btn btn-primary">Send</button>
  </div>
</form>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const container = document.getElementById('messages');

function renderMessage(m){
  const el = document.createElement('div');
  el.innerHTML = `<small class="text-muted">${m.timestamp}</small> <strong>${m.username}</strong>: ${m.content}`;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

// Load initial history
async function loadHistory(){
  const res = await fetch('/messages');
  const msgs = await res.json();
  container.innerHTML = '';
  msgs.forEach(renderMessage);
}

// Receive broadcasts
socket.on('new_message', (m)=>{
  renderMessage(m);
});

document.getElementById('msgform').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const content = document.getElementById('content').value;
  if(!content) return;
  socket.emit('send_message', {content});
  document.getElementById('content').value = '';
});

loadHistory();
</script>
{% endblock %}